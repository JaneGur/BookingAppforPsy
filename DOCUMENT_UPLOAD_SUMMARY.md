# ✅ Загрузка документов с компьютера - Готово!

## 🎉 Что было добавлено

### 1. **API Endpoint для загрузки файлов**
- 📁 `app/api/admin/documents/upload/route.ts`
- ✅ Поддержка FormData
- ✅ Валидация типа файла (PDF, DOC, DOCX)
- ✅ Валидация размера (макс 10 МБ)
- ✅ Загрузка в Supabase Storage
- ✅ Автоматическое получение публичной ссылки
- ✅ Деактивация старых документов
- ✅ Rollback при ошибках

### 2. **Обновленный UI**
- 🔄 **Переключатель метода загрузки:**
  - 📤 Загрузить файл (новое!)
  - 🔗 Указать URL (как было)

- 📤 **Drag & Drop зона для файлов:**
  - Красивая область загрузки
  - Предпросмотр выбранного файла
  - Отображение имени и размера файла
  - Возможность замены файла

- ✅ **Валидация на клиенте:**
  - Проверка типа файла
  - Проверка размера
  - Уведомления об ошибках

- 🎨 **Визуальная обратная связь:**
  - Спиннер при загрузке
  - Тексты состояний (Загрузка файла... / Сохранение...)
  - Toast-уведомления

### 3. **Supabase Storage**
- 📦 Bucket: `documents`
- 🌐 Публичный доступ (по ссылке)
- 🔒 Загрузка только для админов
- 🗑️ Удаление только для админов

### 4. **Документация**
- 📚 `docs/SETUP_DOCUMENTS_STORAGE.md` - пошаговая настройка Storage
- 📝 `supabase/create-documents-bucket.sql` - SQL для создания bucket
- ✅ `DOCUMENT_UPLOAD_SUMMARY.md` (этот файл)

---

## 🔧 Технические детали

### Валидация файлов

**Разрешенные форматы:**
- `application/pdf` - PDF
- `application/msword` - DOC
- `application/vnd.openxmlformats-officedocument.wordprocessingml.document` - DOCX

**Ограничения:**
- Максимальный размер: **10 МБ**
- Валидация на клиенте **и** сервере

### Структура имени файла

```
{doc_type}_{timestamp}_{sanitized_filename}
```

**Пример:**
```
offer_1737538800000_Dogovor_oferty.pdf
policy_1737538900000_Privacy_policy.docx
```

### Процесс загрузки

```
1. Пользователь выбирает файл
   ↓
2. Валидация на клиенте (тип, размер)
   ↓
3. FormData отправляется на сервер
   ↓
4. Валидация на сервере
   ↓
5. Загрузка в Supabase Storage
   ↓
6. Получение публичной ссылки
   ↓
7. Деактивация старого документа
   ↓
8. Сохранение в БД с URL
   ↓
9. Успех! ✅
```

### При ошибках

Если сохранение в БД не удалось:
- Загруженный файл автоматически удаляется из Storage
- Rollback гарантирует целостность данных

---

## 📋 Инструкция для пользователя

### Настройка (один раз)

1. **Создайте bucket в Supabase:**
   - Откройте Supabase Dashboard
   - Storage → New bucket
   - Name: `documents`
   - Public: ✅
   - Create

2. **Настройте политики:**
   ```sql
   -- Выполните в SQL Editor
   -- См. supabase/create-documents-bucket.sql
   ```

3. **Проверьте:**
   ```sql
   SELECT * FROM storage.buckets WHERE id = 'documents';
   ```

### Использование

1. **Откройте админ-панель:** `/admin/settings`
2. **Перейдите на вкладку "Документы"**
3. **Выберите метод "Загрузить файл"**
4. **Заполните форму:**
   - Тип документа: Оферта / Политика
   - Название: Название документа
   - Файл: Выберите PDF/DOC/DOCX
5. **Нажмите "Загрузить документ"**
6. **Готово!** Документ загружен и доступен по ссылке

---

## 🎨 Примеры UI

### Переключатель метода
```
┌─────────────────┬─────────────────┐
│ 📤 Загрузить    │ 🔗 Указать URL  │
│    файл         │                 │
│   (АКТИВНО)     │                 │
└─────────────────┴─────────────────┘
```

### Зона загрузки файла (пустая)
```
╔═══════════════════════════════════╗
║                                   ║
║           📤 Upload               ║
║                                   ║
║   Нажмите для выбора файла        ║
║   PDF, DOC, DOCX (макс 10 МБ)    ║
║                                   ║
╚═══════════════════════════════════╝
```

### Зона загрузки файла (с файлом)
```
╔═══════════════════════════════════╗
║         ┌─────────────┐           ║
║         │  📄 Icon    │           ║
║         └─────────────┘           ║
║      Dogovor_oferty.pdf           ║
║            2.45 МБ                ║
║     Нажмите для замены            ║
╚═══════════════════════════════════╝
```

### Кнопка загрузки
```
┌─────────────────────────────┐
│  📤 Загрузить документ      │
└─────────────────────────────┘

(При загрузке)
┌─────────────────────────────┐
│  ⏳ Загрузка файла...       │
└─────────────────────────────┘
```

---

## ✨ Особенности

### 1. **Два метода на выбор**
- Загрузка файла - для новых документов
- URL - для документов на внешних хостингах

### 2. **Умная валидация**
- Проверка на клиенте (быстро)
- Проверка на сервере (надежно)
- Понятные сообщения об ошибках

### 3. **Красивый UI**
- Drag & Drop зона
- Предпросмотр файла
- Индикатор загрузки
- Toast-уведомления

### 4. **Безопасность**
- Только для админов
- Валидация типов файлов
- Ограничение размера
- Санитизация имен файлов

---

## 📊 Статистика

- **Новых файлов:** 2
- **Строк кода (backend):** ~120
- **Строк кода (frontend):** ~150
- **SQL-скриптов:** 1
- **Документов:** 1

---

## ✅ Checklist

- [x] API endpoint для загрузки
- [x] Валидация файлов (тип, размер)
- [x] Загрузка в Supabase Storage
- [x] Получение публичных ссылок
- [x] Переключатель метода загрузки
- [x] Drag & Drop зона
- [x] Предпросмотр файла
- [x] Toast-уведомления
- [x] Обработка ошибок
- [x] SQL для создания bucket
- [x] Документация

---

## 🚀 Готово к использованию!

Теперь администратор может:
1. ✅ Загружать документы прямо с компьютера
2. ✅ Или указывать URL (как раньше)
3. ✅ Видеть предпросмотр перед загрузкой
4. ✅ Получать уведомления о статусе

---

**Следующий шаг:** Настройте bucket в Supabase (см. `docs/SETUP_DOCUMENTS_STORAGE.md`)

**Версия:** 1.0.0  
**Дата:** 22 января 2026
